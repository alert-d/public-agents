{
  "description": "Convert a coastal city name to coordinates and get historical marine weather data for analysis of wave patterns, sea surface temperature trends, and ocean current variations.",
  "type": "plan",
  "version": "v0.0.1",
  "agent": "openmeteo/marineforecast",
  "serial": [
    {
      "description": "Geocode the coastal city name to get coordinates",
      "type": "fetch",
      "method": "GET",
      "url": "https://geocoding-api.open-meteo.com/v1/search",
      "params": {
        "name": "San Diego",
        "count": "1",
        "language": "en",
        "format": "json"
      },
      "stream": true,
      "name": "geocodingResults",
      "testOutput": [
        "${ function($OUTPUT) { $test($OUTPUT.results, 'geocoding results exist') } }",
        "${ function($OUTPUT) { $test($OUTPUT.results[0].latitude, 'latitude exists in geocoding results') } }",
        "${ function($OUTPUT) { $test($OUTPUT.results[0].longitude, 'longitude exists in geocoding results') } }",
        "${ function($OUTPUT) { $test($OUTPUT.results[0].name, 'location name exists in geocoding results') } }",
        "${ function($OUTPUT) { $test($OUTPUT.results[0].timezone, 'timezone exists in geocoding results') } }"
      ]
    },
    {
      "description": "Get historical marine weather data for the specified period",
      "type": "fetch",
      "method": "GET",
      "url": "https://archive-api.open-meteo.com/v1/archive",
      "params": {
        "latitude": "${$geocodingResults.results[0].latitude}",
        "longitude": "${$geocodingResults.results[0].longitude}",
        "start_date": "2023-01-01",
        "end_date": "2023-12-31",
        "daily": "wave_height_max,wave_direction_dominant,wave_period_max",
        "timezone": "${$geocodingResults.results[0].timezone}"
      },
      "stream": true,
      "name": "historicalMarineData",
      "testInput": [
        "${ function() { $test($geocodingResults.results[0].latitude, 'latitude from geocoding available') } }",
        "${ function() { $test($geocodingResults.results[0].longitude, 'longitude from geocoding available') } }",
        "${ function() { $test($geocodingResults.results[0].timezone, 'timezone from geocoding available') } }"
      ],
      "testOutput": [
        "${ function($OUTPUT) { $test($OUTPUT.daily, 'daily historical marine data exists') } }",
        "${ function($OUTPUT) { $test($OUTPUT.daily.time, 'daily time data exists') } }",
        "${ function($OUTPUT) { $test($OUTPUT.daily.wave_height_max, 'daily wave height max data exists') } }",
        "${ function($OUTPUT) { $test($OUTPUT.daily.wave_direction_dominant, 'daily wave direction dominant data exists') } }",
        "${ function($OUTPUT) { $test($OUTPUT.daily.wave_period_max, 'daily wave period max data exists') } }"
      ]
    },
    {
      "description": "Display daily marine data in table format",
      "type": "table",
      "title": "Daily Marine Data",
      "stream": false,
      "name": "marineTable",
      "input": "${$zip($historicalMarineData.daily.time, $historicalMarineData.daily.wave_height_max, $historicalMarineData.daily.wave_direction_dominant, $historicalMarineData.daily.wave_period_max) ~> $map(function($row) { {\"date\": $row[0], \"wave_height_max\": $row[1], \"wave_direction_dominant\": $row[2], \"wave_period_max\": $row[3]} })}",
      "testInput": [
        "${ function() { $test($historicalMarineData.daily.time, 'daily time data available for table') } }",
        "${ function() { $test($historicalMarineData.daily.wave_height_max, 'daily wave height max data available for table') } }",
        "${ function() { $test($historicalMarineData.daily.wave_direction_dominant, 'daily wave direction dominant data available for table') } }",
        "${ function() { $test($historicalMarineData.daily.wave_period_max, 'daily wave period max data available for table') } }"
      ],
      "testOutput": [
        "${ function($OUTPUT) { $test($type($OUTPUT) = 'array', 'table output is array') } }",
        "${ function($OUTPUT) { $test($OUTPUT[0].date, 'date field exists in table output') } }",
        "${ function($OUTPUT) { $test($OUTPUT[0].wave_height_max, 'wave_height_max field exists in table output') } }",
        "${ function($OUTPUT) { $test($OUTPUT[0].wave_direction_dominant, 'wave_direction_dominant field exists in table output') } }",
        "${ function($OUTPUT) { $test($OUTPUT[0].wave_period_max, 'wave_period_max field exists in table output') } }"
      ]
    },
    {
      "description": "Analyze historical marine weather data and provide insights",
      "model": "gpt-4",
      "type": "llm",
      "stream": true,
      "input": "${$marineTable}",
      "query": "Analyze the historical marine weather data for ${$transformHistoricalMarine.location}. The data contains daily wave height maximums, dominant wave directions, and wave period maximums. Provide insights about: 1) Wave pattern trends and seasonal variations, 2) Notable wave events and extremes, 3) Wave direction patterns and their implications, 4) Practical observations for marine activities and safety. Include specific data points, averages, and recommendations based on the historical patterns.",
      "testInput": [
        "${ function() { $test($marineTable~>$type() ='array', 'input to llm is an array') } }",
        "${ function() { $test($marineTable[0].date, 'date field exists in llm input') } }",
        "${ function() { $test($marineTable[0].wave_height_max, 'wave_height_max field exists in llm input') } }",
        "${ function() { $test($marineTable[0].wave_direction_dominant, 'wave_direction_dominant field exists in llm input') } }",
        "${ function() { $test($marineTable[0].wave_period_max, 'wave_period_max field exists in llm input') } }"
      ]
    }
  ]
}
